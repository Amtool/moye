/*! 2014 Baidu Inc. All Rights Reserved */
define("PicUploader",["require","./lib","./Control"],function(require){function t(t,e){var i=new FileReader(t);i.onload=function(t){e&&e(t.target.result),i=null},i.readAsDataURL(t)}function e(t){var e=document.createElement("input");e.type="file";for(var i in t)e[i]=t[i];return e}var i=require("./lib"),n=require("./Control"),s="FileReader"in window,a={getClass:function(t){return t=t?"-"+t:"",this.options.prefix+t},getDom:function(t,e){return i.q(a.getClass.call(this,t),i.g(e))[0]},onCloseClick:function(t){var e=i.getTarget(t),n=i.getAncestorByClass(e,a.getClass.call(this,"picker"));a.removePicker.call(this,n)},onFileChange:function(n){var r=i.getTarget(n),o=r.value;if(o){var l=o.slice(Math.max(o.lastIndexOf("/"),o.lastIndexOf("\\"))+1);l=l.slice(0,l.lastIndexOf("."));var h=i.getAncestorByClass(r,a.getClass.call(this,"picker")),c=this._bound;if(!o.match(this.options.fileType)){if(i.browser.ie){var f=e({className:r.className});r.parentNode.insertBefore(f,r),i.un(r,"change",c.onFileChange),r.parentNode.removeChild(r),i.on(f,"change",c.onFileChange)}else r.value="";i.addClass(h,a.getClass.call(this,"error")),this.fire("pickerror",{fileName:o})}else{var u=a.getDom.call(this,"pic",h);if(s)t(r.files[0],function(t){var e=document.createElement("IMG");e.src=t,u.appendChild(e),u=null});else u.innerHTML="<em>"+l+"</em>";if(h.title=l,a.getDom.call(this,"title",h).innerHTML=l,i.removeClass(h,a.getClass.call(this,"cur")),i.removeClass(h,a.getClass.call(this,"error")),i.addClass(h,a.getClass.call(this,"picked")),i.un(r,"change",c.onFileChange),this.count++,this.count<this.options.maxCount)a.create.call(this);this.fire("pick",{fileName:o})}}},removePicker:function(t){var e=a.getDom.call(this,"file",t).value,n=this._bound;if(i.un(a.getDom.call(this,"file",t),"change",n.onFileChange),i.un(a.getDom.call(this,"close",t),"click",n.onCloseClick),t.parentNode.removeChild(t),this.count--,this.count===this.options.maxCount-1)a.create.call(this);this.fire("remove",{fileName:e})},bindPicker:function(t){var e=this._bound;i.on(a.getDom.call(this,"file",t),"change",e.onFileChange),i.on(a.getDom.call(this,"close",t),"click",e.onCloseClick)},create:function(){var t={closeClass:a.getClass.call(this,"close"),picClass:a.getClass.call(this,"pic"),titleClass:a.getClass.call(this,"title"),fileClass:a.getClass.call(this,"file"),wrapperClass:a.getClass.call(this,"wrapper")},e=this.createElement("div",{className:a.getClass.call(this,"picker")+" "+a.getClass.call(this,"cur")});e.innerHTML=this.options.tpl.replace(/#\{([\w-.]+)\}/g,function(e,i){return t[i]||""}),this.options.main.appendChild(e),a.bindPicker.call(this,this.curPicker=e)}},r=n.extend({type:"PicUploader",options:{main:"",prefix:"ecl-ui-picuploader",maxCount:3,fileType:/\.(jpg|png|gif|jpeg)$/,tpl:'<div class="#{closeClass}" title="关闭">×</div><div class="#{picClass}"></div><div class="#{titleClass}">点击上传</div><a href="javascript:;" class="#{wrapperClass}"><input type="file" class="#{fileClass}"></a>'},count:0,init:function(t){if(!t.main&&1!==t.main.nodeType)throw new Error("invalid main");if(this.bindEvents(a),this._disabled=t.disabled,this._disabled)this.disable()},render:function(){if(!this.rendered)a.create.call(this),this.rendered=!0;return this},remove:function(t,e){var n=this;return e=e||function(t,e,i){return t===e},i.each(i.q(a.getClass.call(this,"file"),this.options.main),function(s,r){if(s.value===t)if(e(s.value,t,r))a.removePicker.call(n,i.getAncestorByClass(s,a.getClass.call(n,"picker")))}),this},removeAt:function(t){var e=i.q(a.getClass.call(this,"picker"),this.options.main);if(e[t]!==this.curPicker)a.removePicker.call(this,e[t]);return this},getFileList:function(){var t=this,e=[];return i.each(i.q(a.getClass.call(this,"file"),this.options.main),function(i){if(i.value.match(t.options.fileType))e.push(i.value)}),e},enable:function(){if(this.curPicker)i.removeClass(this.options.main,a.getClass.call(this,"disabled"));return this._disabled=0,this},disable:function(){if(this.curPicker)i.addClass(this.options.main,a.getClass.call(this,"disabled"));return this._disabled=1,this},dispose:function(){if(this.curPicker){var t=this._bound;i.un(a.getDom.call(this,"file",this.curPicker),"change",t.onFileChange),i.un(a.getDom.call(this,"close",this.curPicker),"click",t.onCloseClick),this.curPicker=0}this.options.main.innerHTML="",this.parent("dispose")}});return r});