/*! 2014 Baidu Inc. All Rights Reserved */
define("Tip",["require","./lib","./Control"],function(require){var t=require("./lib"),e=t.dom,i=t.page,s=require("./Control"),n=function(e,i){var s=t.getTarget(e);if(!t.hasClass(s,i))if(s=t.getAncestorByClass(s,i),!s)return null;return s},a={clear:function(){clearTimeout(this._showTimer),clearTimeout(this._hideTimer),clearTimeout(this._resizeTimer)},onClick:function(t){this.fire("click",{event:t})},onResize:function(){clearTimeout(this._resizeTimer);var t=this;this._resizeTimer=setTimeout(function(){t.show(t.current)},100)},onDocClick:function(i){var s=this.main,r=n(i,this.options.flag);if(s!==r&&!~t.array.indexOf(this.triggers,r)&&!e.contains(s,r))a.onHide.call(this)},onShow:function(e){var i=n(e,this.options.flag);if(a.clear.call(this),i&&this.current!==i){var s=this.events,r=this._bound;if(s){if(t.on(i,s.un,r.onHide),t.un(i,s.on,r.onShow),this.current)t.on(this.current,s.on,r.onShow),t.un(this.current,s.un,r.onHide);if("click"===this.options.mode)t.on(document,"click",r.onDocClick)}this.current=i,this.fire("beforeShow",{target:i,event:e});var o=this.options.showDelay;if(o){var l=this;this._showTimer=setTimeout(function(){l.show(i)},o)}else this.show(i)}},onHide:function(){var t=this,e=this.options;if(a.clear.call(t),e.hideDelay){var t=this;this._hideTimer=setTimeout(function(){t.hide()},e.hideDelay)}else this.hide()},onMouseEnter:function(){a.clear.call(this)},onMouseLeave:function(){var t=this,e=t.options;if(a.clear.call(t),e.hideDelay)t._hideTimer=setTimeout(function(){t.hide()},e.hideDelay);else t.hide()},computePosition:function(){var t=this.options,s=this.current,n=this.main,a=this.elements.arrow,r=t.arrow,o=e.getPosition(s),l=t.prefix+"-arrow",h=o.top,c=o.left,u=s.offsetWidth,d=s.offsetHeight,f=c+u,p=h+d,m=c+u/2,g=h+d/2,v=n.offsetWidth,b=n.offsetHeight,C=a.firstChild.offsetWidth,y=a.firstChild.offsetHeight,x=i.getScrollTop(),w=i.getScrollLeft(),k=w+i.getViewWidth(),T=x+i.getViewHeight(),M=s.getAttribute("data-tooltips");if(M)r=/[trblc]{2}/.test(M)?M:"1";var D,S;if(!r||"1"===r){var E=u>v||c-(v-u)/2>0&&k>=f+(v-u)/2?"c":c+v>k?"r":"l",_=d>b||h-(b-d)/2>0&&T>=p+(b-d)/2?"c":h+b>T?"b":"t";if(T>=p+y+b)S="b",D=E;else if(k>=f+v+C)S="r",D=_;else if(h-b-y>=x)S="t",D=E;else if(c-v-C>=w)S="l",D=_;r=S+D}else S=r.charAt(0),D=r.charAt(1);var A={l:"left",r:"right",t:"top",b:"bottom"},H=t.offset;if(a.className=l+" "+l+"-"+A[S],C=a.firstChild.offsetWidth,y=a.firstChild.offsetHeight,{t:1,b:1}[S]){c={l:c+H.x,c:m-v/2,r:f-v-H.x}[D],h={t:h-y-b-H.y,b:p+y+H.y}[S];var P=(u-C)/2;a.style.left={c:(v-C)/2,l:P-H.x,r:v-Math.max(C,P)+H.x}[u>v?"c":D]+"px",a.style.top=""}else if({l:1,r:1}[S]){h={t:h+H.y,c:g-b/2,b:p-b-H.y}[D],c={l:c-C-v-H.x,r:f+C+H.x}[S];var N=(d-y)/2;a.style.top={c:(b-y)/2,t:N-H.y,b:b-Math.max(y,N)+H.y}[d>b?"c":D]+"px",a.style.left=""}e.setStyles(n,{left:c+"px",top:h+"px"})}},r=s.extend({type:"Tip",options:{disabled:!1,main:"",arrow:!1,showDelay:100,hideDelay:300,mode:"over",title:null,content:"",prefix:"ecl-ui-tip",triggers:"tooltips",flag:"_ecui_tips",offset:{x:0,y:0},tpl:'<div class="{prefix}-arrow {prefix}-arrow-top"><em></em><ins></ins></div><div class="{prefix}-title"></div><div class="{prefix}-body"></div>'},init:function(t){t.hideDelay=t.hideDelay<0?r.HIDE_DELAY:t.hideDelay,this._disabled=t.disabled,this.title=t.title,this.content=t.content;var e=t.prefix,i=this.main=document.createElement("div");i.className=e,i.innerHTML=t.tpl.replace(/{prefix}/g,e),i.style.left="-2000px",this.events={over:{on:"mouseenter",un:"mouseleave"},click:{on:"click",un:"click"}}[t.mode],this.bindEvents(a)},render:function(){var e=this,i=this.main,s=this.options,n=this.events;if(!this.rendered){this.rendered=!0,document.body.appendChild(i);var a=this._bound;if(t.on(i,"click",a.onClick),"over"===this.options.mode)t.on(i,"mouseenter",a.onMouseEnter),t.on(i,"mouseleave",a.onMouseLeave);var r=this.elements={},o=s.prefix+"-";t.each("arrow,title,body".split(","),function(e){r[e]=t.q(o+e,i)[0]}),this.addTriggers(s.triggers)}if(!n&&this.triggers)if(s.showDelay)this._showTimer=setTimeout(function(){e.show(e.triggers[0])});else this.show(this.triggers[0]);return this},addTriggers:function(e){var i=this.options,s=this.events,n=i.flag;this.triggers="string"==typeof e?t.q(i.triggers):e.length?e:[e];var a=this._bound.onShow;if(s)t.each(this.triggers,function(e){if(!t.hasClass(e,n))t.addClass(e,n),t.on(e,s.on,a)})},refresh:function(e,i){var s=this.events;e="string"==typeof e?t.q(e,i):e.length?e:[e];var n=this._bound;if(s){if(this.triggers)t.each(e,function(i){if(!e.parentElement)t.un(i,s.on,n.onShow),t.un(i,s.un,n.onHide)});this.addTriggers(e)}},show:function(e){var i=this.options,s=this.elements;if(a.clear.call(this),this.current=e,t.on(window,"resize",this._bound.onResize),s.title.innerHTML=this.title||"",s.body.innerHTML=this.content,t[this.title?"show":"hide"](s.title),!i.arrow)t.hide(s.arrow);a.computePosition.call(this),this._visible=!0,this.fire("show",{target:e})},hide:function(){var e=this.main,i=this.events,s=this.current,n=this._bound;if(i&&s)if(t.on(s,i.on,n.onShow),t.un(s,i.un,n.onHide),"click"===this.options.mode)t.un(document,"click",n.onDocClick);a.clear.call(this);var r=this.elements.arrow;e.style.left=-e.offsetWidth-r.offsetWidth+"px",this._visible=!1,this.current=null,t.un(window,"resize",n.onResize),this.fire("hide")},isVisible:function(){return!!this._visible},setTitle:function(e){this.title=e||"";var i=this.elements;i.title.innerHTML=this.title,t[this.title?"show":"hide"](i.title)},setContent:function(t){this.content=t||"",this.elements.body.innerHTML=this.content},dispose:function(){var e=this.options,i=this.events,s=this._bound;if(i){var n=e.flag;t.each(this.triggers||[],function(e){if(t.hasClass(e,n))t.removeClass(e,n),t.un(e,i.on,s.onShow)})}var a=this.main;if("over"===e.mode)t.un(a,"mouseenter",s.onMouseEnter),t.un(a,"mouseleave",s.onMouseLeave);else t.un(document,"click",s.onDocClick);this.current=null,this.parent("dispose")}});return r});