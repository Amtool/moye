<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Moye</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="icon" href="/favicon.png">
    
    
    
<link rel="stylesheet" href="/moye/css/post.css" type="text/css">

    
    <link rel="alternative" href="/atom.xml" title="Moye" type="application/atom+xml">
    
</head>
<body>
    
    <div id="container">
    <article id="post-plugin" class="article article-type-post" itemscope itemprop="blogPost">

  <nav class="article-nav">

  <a class="article-nav-logo" href="/moye/index.html">
    <img src="/moye/img/moye.png" alt="moye" /> Moye
  </a>

  
    <div class="article-nav-category">
      <h4 class="article-nav-category-title">
        
        <a class="article-nav-category-link" href=/moye/introduction/get-started.html>开始</a>
        
      </h4>

      
    </div>
  
    <div class="article-nav-category">
      <h4 class="article-nav-category-title">
        
        组件
        
      </h4>

      
        <a class="article-nav-category-link "
          href="/moye/component/Button.html">
          按钮 / Button 
        </a>
      
        <a class="article-nav-category-link "
          href="/moye/component/Calendar.html">
          日历 / Calendar 
        </a>
      
        <a class="article-nav-category-link "
          href="/moye/component/City.html">
          城市选择器 / City 
        </a>
      
        <a class="article-nav-category-link "
          href="/moye/component/Dialog.html">
          对话框 / Dialog 
        </a>
      
        <a class="article-nav-category-link "
          href="/moye/component/LazyImg.html">
          懒图片 / LazyImg 
        </a>
      
        <a class="article-nav-category-link "
          href="/moye/component/Marquee.html">
          走马灯 / Marquee 
        </a>
      
        <a class="article-nav-category-link "
          href="/moye/component/Pager.html">
          翻页器 / Pager 
        </a>
      
        <a class="article-nav-category-link "
          href="/moye/component/Popup.html">
          浮层 / Popup 
        </a>
      
        <a class="article-nav-category-link "
          href="/moye/component/Rating.html">
          评分 / Rating 
        </a>
      
        <a class="article-nav-category-link "
          href="/moye/component/Select.html">
          下拉框 / Select 
        </a>
      
        <a class="article-nav-category-link "
          href="/moye/component/Slider.html">
          轮播图 / Slider 
        </a>
      
        <a class="article-nav-category-link "
          href="/moye/component/Tab.html">
          选项卡 / Tab 
        </a>
      
        <a class="article-nav-category-link "
          href="/moye/component/TextBox.html">
          文本框 / TextBox 
        </a>
      
        <a class="article-nav-category-link "
          href="/moye/component/Tip.html">
          提示 / Tip 
        </a>
      
        <a class="article-nav-category-link "
          href="/moye/component/Form.html">
          表单 / Form 
        </a>
      
        <a class="article-nav-category-link "
          href="/moye/component/BoxGroup.html">
          单复选框 / BoxGroup 
        </a>
      
    </div>
  
    <div class="article-nav-category">
      <h4 class="article-nav-category-title">
        
        简介
        
      </h4>

      
        <a class="article-nav-category-link "
          href="/moye/introduction/get-started.html">
          开始 / get started 
        </a>
      
        <a class="article-nav-category-link "
          href="/moye/introduction/best-practice.html">
          最佳实践 / best practice 
        </a>
      
    </div>
  
    <div class="article-nav-category">
      <h4 class="article-nav-category-title">
        
        开发 moye
        
      </h4>

      
        <a class="article-nav-category-link "
          href="/moye/introduction/develop.html">
          开发指南 / introduction 
        </a>
      
        <a class="article-nav-category-link current"
          href="/moye/introduction/plugin.html">
          插件 / Plugin 
        </a>
      
        <a class="article-nav-category-link "
          href="/moye/introduction/life-cycle.html">
          生命周期 / life cycle 
        </a>
      
        <a class="article-nav-category-link "
          href="/moye/introduction/skin.html">
          皮肤 / skin 
        </a>
      
        <a class="article-nav-category-link "
          href="/moye/introduction/inherits.html">
          继承 / inherits 
        </a>
      
    </div>
  

</nav>


  <div class="article-content">
    <header class="article-header">
      
  
    <h1 class="article-title" itemprop="name">
      插件 / Plugin
      <!-- Place this tag where you want the button to render. -->
      <a class="github-button" href="https://github.com/ecomfe/moye" data-icon="octicon-star" data-style="mega" data-count-href="/ecomfe/moye/stargazers" data-count-api="/repos/ecomfe/moye#stargazers_count" data-count-aria-label="# stargazers on GitHub" aria-label="Star ecomfe/moye on GitHub">Star</a>
    </h1>
  


    </header>
    <div class="article-entry markdown-body" itemprop="articleBody">
      <h2 id="moye插件机制">moye插件机制</h2><p>出于性能考虑, <code>moye</code>控件只保留最小功能集合. 许多增强功能是由<code>插件</code>来协助完成的.</p>
<p>例如, 在<code>获取校验码</code>按钮一般情况都有一个冷却时间60秒. 点击之后60秒内是禁用的, 此时按钮文字显示冷却时间的倒计时. 此功能不方便直接写在<code>Button</code>控件中, 即可编写一个<code>插件</code>来完成.</p>
<h3 id="使用方式">使用方式</h3><p>可以使用两种方式来激活一个控件</p>
<ol>
<li><p>通过构造参数<code>plugins</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'moye/plugin/ButtonCooldown'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> button = <span class="keyword">new</span> Button(&#123;</span><br><span class="line">  main: <span class="built_in">document</span>.getElementById(<span class="string">'some-button'</span>),</span><br><span class="line">  plugins: [<span class="string">'ButtonCoolDown'</span>]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过调用接口<code>use()</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'moye/plugin/ButtonCooldown'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> button = <span class="keyword">new</span> Button(&#123;</span><br><span class="line">  main: <span class="built_in">document</span>.getElementById(<span class="string">'some-button'</span>)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">button.use(<span class="string">'ButtonCooldown'</span>);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="如何编写一个插件">如何编写一个插件</h3><h4 id="基础">基础</h4><p>我们提供了一个<code>Plugin</code>的基类, 其中定义了<code>Plugin</code>所需要的几个接口:</p>
<ol>
<li>activate({Control}) 激活插件, 在控件初始化时调用. <strong>必须重写</strong></li>
<li>inactivate()        禁用插件, 在有必要禁用插件时调用. <strong>有必要时重写</strong></li>
<li>dispose()           销毁插件, 在控件被销毁时调用. <strong>有必要时重写</strong></li>
</ol>
<p>因此, 大家在编写插件时, 首先需要引入基类<code>Plugin</code>, 然后从<code>Plugin</code>上生成新的插件并重写上边的三个方法. 示例:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ExamplePlugin = Plugin.extend(&#123;</span><br><span class="line">  activate: <span class="function"><span class="keyword">function</span> (<span class="params">control</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.control = control;</span><br><span class="line">  &#125;,</span><br><span class="line">  dispose: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.control = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="最优实践">最优实践</h4><ol>
<li><p>扩展控件的方法</p>
<p>挂接方法是指将额外方法挂接到控件实例上, 来提供扩展功能. 例如:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ButtonCooldown = Plugin.extend(&#123;</span><br><span class="line">  activate: <span class="function"><span class="keyword">function</span> (<span class="params">control</span>) </span>&#123;</span><br><span class="line">    control.startCooldown = $.proxy(<span class="keyword">this</span>.start, <span class="keyword">this</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  start: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 开始倒计时</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>插件激活后, 控件就会获得<code>startCooldown</code>的方法, 可以在合适的时候进行调用.</p>
<blockquote>
<p>请尽量不要覆盖<code>控件</code>原有方法. 入侵式挂接可能会导致不可预期的逻辑混乱.</p>
</blockquote>
</li>
<li><p>扩展控件的事件</p>
<blockquote>
<p><code>插件</code>触发<code>寄主控件</code>事件, <code>寄主</code>是事件源, 即<code>control.fire(&#39;plugin-special-event&#39;)</code>;</p>
<p>插件本身没有实现<code>Observable</code>接口, 不能释放事件;</p>
<p>理论上讲, 从外部来看, 使用者没有办法获取到插件实例;</p>
</blockquote>
<p>激活插件后, 根据插件的属性或者监听控件的事件, 结合控件自身逻辑, 在合适的时机在<code>控件实例</code>上触发事件. 例如:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Validator = Plugin.extend(&#123;</span><br><span class="line"></span><br><span class="line">  activate: <span class="function"><span class="keyword">function</span> (<span class="params">control</span>) </span>&#123;</span><br><span class="line">    control.on(<span class="string">'change'</span>, $.proxy(<span class="keyword">this</span>.validate, <span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">this</span>.rules = control.rules;</span><br><span class="line">    <span class="keyword">this</span>.control = control;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  validate: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 根据rules所定义的规则来计算当前用户输入是否合法</span></span><br><span class="line">    <span class="keyword">var</span> state = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// 其他插件可以`invalid`事件来完成相应的交互.</span></span><br><span class="line">    <span class="comment">// 例如, ValidityTip插件就是监听事件`invalid`来触发错误提示信息的展现的.</span></span><br><span class="line">    <span class="keyword">this</span>.control.fire(<span class="string">'invalid'</span>);</span><br><span class="line">    <span class="keyword">return</span> state;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>以上示例简单完成了两个功能</p>
<ol>
<li>当<code>寄主控件</code>发生了<code>change</code>事件时, 进行校验.</li>
<li>如果校验失败, 在<code>寄主控件</code>上触发事件<code>invalid</code>.</li>
</ol>
<p><code>插件事件</code>是多插件合作的基础. 由于<code>插件A</code>没办法知晓<code>插件B</code>是否存在, 因此也就没有一个明确的接口可以使用. 所以插件与插件之间的合作都是通过<code>寄主控件</code>的插件事件来完成的.</p>
</li>
<li><p>插件如何获取参数</p>
<p>我们推荐直接将插件参数添在控件上, 在开发插件时直接从插件上获取. 示例:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">TextBoxPlaceholder = Plugin.extend(&#123;</span><br><span class="line">  activate: <span class="function"><span class="keyword">function</span> (<span class="params">control</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (lib.browser.ie &lt; <span class="number">9</span> &amp;&amp; control.placeholder) &#123;</span><br><span class="line">      <span class="comment">// 只有当浏览器为ie678并且Textbox需要一个placeholder时我们才继续</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
</li>
<li><p>插件的执行时机</p>
<p>我们推荐监听控件的 <code>生命周期事件</code> / <code>交互事件</code> 来完成控件状态转化. 例如:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">TextBoxPlaceholder = Plugin.extend(&#123;</span><br><span class="line">  activate: <span class="function"><span class="keyword">function</span> (<span class="params">control</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (lib.browser.ie &lt; <span class="number">9</span> &amp;&amp; control.placeholder) &#123;</span><br><span class="line">      control.on(<span class="string">'afterrender'</span>, $.proxy(<span class="keyword">this</span>.buildPlaceHoder, <span class="keyword">this</span>);</span><br><span class="line">      <span class="keyword">this</span>.control = control;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  build: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 生成placeholder所需要的元素</span></span><br><span class="line">    <span class="comment">// 事件绑定</span></span><br><span class="line">    <span class="comment">// 等等...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>上边这个示例中所定义的TextBoxPlaceHolder是用来兼容ie678上input的placeholder属性的. 那么在需要在控件完成渲染后才能进行插件所需要的额外逻辑的执行.</p>
</li>
</ol>
<h4 id="代码示例">代码示例</h4><p>下边的代码简要地介绍如何编写一个插件:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">define(function (require) &#123;</span><br><span class="line"></span><br><span class="line">    var $ = require('jquery');</span><br><span class="line">    var Plugin = require('./Plugin');</span><br><span class="line">    var lib = require('../lib');</span><br><span class="line"></span><br><span class="line">    var ButtonCooldown = Plugin.extend(&#123;</span><br><span class="line"></span><br><span class="line">        $class: 'ButtonCooldown',</span><br><span class="line"></span><br><span class="line">        /**</span><br><span class="line">         * 默认参数</span><br><span class="line">         * @type &#123;Object&#125;</span><br><span class="line">         */</span><br><span class="line">        options: &#123;</span><br><span class="line">          // 这里放置的参数会自动与构造参数合并, 构造参数的优先级高于此处</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        activate: function (target) &#123;</span><br><span class="line">          this.target = target;</span><br><span class="line">          target.startCooldown  = $.proxy(this.startCooldown, this);</span><br><span class="line">          target.isCooling      = $.proxy(this.isCooling, this);</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        dispose: function () &#123;</span><br><span class="line">          this.target = null;</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        startCooldown: function (cooldown, interval, message) &#123;</span><br><span class="line">          var me = this;</span><br><span class="line">          me.timer = setInterval(function () &#123;</span><br><span class="line"></span><br><span class="line">            if (me.count--) &#123;</span><br><span class="line">              me.updateButtonText();</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">              me.finishCooldown();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          &#125;, 1000);</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        finishCooldown: function () &#123;</span><br><span class="line">          clearInterval(this.timer);</span><br><span class="line">          this.target.fire('cooldown');</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        isCooling: function () &#123;</span><br><span class="line">            // ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    return ButtonCooldown;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

    </div>

    <footer class="article-footer">

      <div class="duoshuo">

        <!-- 多说评论框 start -->
        <div class="ds-thread" data-thread-key="plugin" data-title="插件 / Plugin" data-url="http://ecomfe.github.io/moye/introduction/plugin.html"></div>

        <!-- 多说评论框 end -->
        <!-- 多说公共JS代码 start (一个网页只需插入一次) -->

        <script type="text/javascript">
        window.duoshuoQuery = {short_name:"moye"};
        (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';
          ds.src = '//static.duoshuo.com/embed.js';
          ds.charset = 'UTF-8';
          document.getElementsByTagName('head')[0].appendChild(ds);
        })();
        </script>
        <!-- 多说公共JS代码 end -->

        <!-- Place this tag right after the last button or just before your close body tag. -->
        <script async defer id="github-bjs" src="https://buttons.github.io/buttons.js"></script>
      </div>

    </footer>
  </div>
</article>

    </div>
    <script src="/moye/js/requirejs.min.js" type="text/javascript"></script>
    <script src="//libs.baidu.com/jquery/2.0.3/jquery.min.js" type="text/javascript"></script>

    <script>
    require.config({
        'baseUrl': '/moye/js',
        'paths': {
            'common': './common',
            'highlight': '../dep/highlight/highlight.pack'
        },
        'packages': [{
            'name': 'moye',
            'location': '../dep/moye',
            'main': 'main'
        }],
        'urlArgs': 'v0.0.1'
    });
    </script>
    
</body>
</html>
