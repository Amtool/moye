/*! 2015 Baidu Inc. All Rights Reserved */
define("moye/Calendar",["require","jquery","./lib","./Control","./Popup","./painter"],function(require){function t(t){var e=new Date(t);return e.setDate(1),e}function e(t){var e=new Date(t);return e.setMonth(e.getMonth()+1),e.setDate(0),e}var i=require("jquery"),n=require("./lib"),a=require("./Control"),s=require("./Popup"),r=n.pad,h="yyyy-MM-dd",o=null,u=a.extend({type:"Calendar",options:{dateFormat:h,range:o,process:null,months:1,weekStart:0,lang:{week:"周",days:"日,一,二,三,四,五,六",title:"{year}年{month}月"},pager:{next:"&#xe606;",prev:"&#xe605;"}},init:function(e){this.$parent(e);var i=this.main;if("INPUT"===i.tagName){var n=document.createElement("div"),a=i.parentNode;if(a)a.insertBefore(n,i);n.appendChild(i),this.main=n,this.input=i}var s=this.value||this.input&&this.input.value,r=this.date=this.parse(s);this.days=this.lang.days.split(","),this.month=t(r),this.value=this.format(r)},getPagerHTML:function(t){var e=this.helper,i=e.getPartId(t),n=["moye-icon"].concat(e.getPartClasses("pager")).concat(e.getPartClasses("pager-"+t)).join(" "),a=this.pager[t];return'<a href="#" data-direction="'+t+'"class="'+n+'" id="'+i+'">'+a+"</a>"},initStructure:function(){var t=this.main,e=this.input;if(!e)e=this.input=i("input",t)[0]||i('<input type="text">').appendTo(t).get(0);var n=this.helper,a=""+this.getPagerHTML("prev")+this.getPagerHTML("next")+n.getPartHTML("content","ol"),r=this.popup=new s({target:e,triggers:[e],content:a,showDelay:0,hideDelay:0});r.render(),n.addPartClasses("popup",r.main),this.prev=n.getPart("prev"),this.next=n.getPart("next"),this.content=n.getPart("content")},initEvents:function(){this.popup.on("click",i.proxy(this.onPopupClick,this)).on("hide",i.proxy(this.onPopupHide,this)).on("show",i.proxy(this.onPopupBeforeShow,this))},repaint:require("./painter").createRepaint(a.prototype.repaint,{name:["range","value"],paint:function(e,i,n){var a=this.date=this.parse(n);if(i){var s=i.begin,r=i.end;if(s)s=i.begin=this.parse(s);if(r)r=i.end=this.parse(r);if(s>a||a>r)n=this.value=this.date="",this.month=t(s||r)}this.input.value=n}},{name:["months","month","range","value"],paint:function(e,i,n){var a=[];i=this.months=i||1,n=t(n||this.month),this.updatePrevNextStatus(n);for(var s=0;i>s;s++)a[s]=this.getMonthHTML(n),n.setMonth(n.getMonth()+1);this.content.innerHTML=a.join("")}}),parse:function(t,e){if(!t)return new Date;if(n.isDate(t))return t;e=e||this.dateFormat,e=e.split(/[^yMdW]+/i),t=t.split(/\D+/);for(var i={},a=0,s=e.length;s>a;a++)if(e[a]&&t[a]&&(e[a].length>1&&t[a].length===e[a].length||1===e[a].length))i[e[a].toLowerCase()]=t[a];var r=i.yyyy||i.y||(i.yy<50?"20":"19")+i.yy,h=0|(i.m||i.mm),o=0|(i.d||i.dd);return new Date(0|r,h-1,o)},format:function(t,e){if(e=(e||this.dateFormat).toLowerCase(),n.isString(t))t=this.parse(t);var i=this.weekStart,a=t.getFullYear(),s=t.getMonth()+1,h=t.getDate(),o=t.getDay();if(i)o=(o-1+7)%7;o=this.days[o];var u={yyyy:a,yy:a%100,y:a,mm:r(s),m:s,dd:r(h),d:h,w:o,ww:this.lang.week+o};return e.replace(/y+|M+|d+|W+/gi,function(t){return u[t]||""})},show:function(t){this.popup.show()},hide:function(){this.popup.hide()},getValue:function(){var t=this.date;return t?this.format(t):""},getRawValue:function(){return this.date},setRange:function(t){this.range=null,this.set("range",t)},setValue:function(t){this.set("value",t)},getYYYYMM:function(t){return n.isString(t)?t:this.format(this.parse(t),"yyyyMM")},getMonthHTML:function(i){var n=this.helper,a=['<li class="'+n.getPartClassName("month")+'">',this.getMonthTitleHTML(i),this.getWeekTitleHTML(),"<p>"],s=t(i),r=e(i),h=s.getDay(),o=new Date(s);o.setDate(1-h);for(var u=0;42>u;u++){if(s>o)a.push(this.getDateHTML(o,"prev-month"));else if(o>r)a.push(this.getDateHTML(o,"next-month"));else a.push(this.getDateHTML(o));o.setDate(o.getDate()+1)}return a.push("</p></li>"),a.join("")},getMonthTitleHTML:function(t){var e=this.helper;return t={year:t.getFullYear(),month:t.getMonth()+1},e.getPartHTML("month-title","div",this.lang.title.replace(/\{([^\}]+)\}/g,function(e,i){return t[i]||""}),{"data-role":"calendar-month-title"})},getWeekTitleHTML:function(){for(var t=["<ul>"],e=this.helper,i=this.days,n=this.weekStart,a=e.getPartClassName("week"),s=this.helper.getPartClassName("weekend"),r=0;7>r;r++){var h=(n+r)%7,o=[a,0===r||6===r?s:""];t.push('<li class="'+o.join(" ")+'">'+i[h]+"</li>")}return t.push("</ul>"),t.join("")},getDateHTML:function(t,e){var n=t.getDay(),a=this.format(t),s=this.helper,r=this.range,h=!!r&&(r.begin>t||r.end<t),o=this.value&&this.value===a,u=this.format(new Date),l=s.getPartClasses("date");if(0===n||6===n)l.push(s.getPartClassName("weekend"));if(e)l.push(s.getPartClassName(e));if(h)l.push(s.getPartClassName("disabled"));if(o)l.push(s.getPartClassName("checked"));if(a===u)l.push(s.getPartClassName("today"));var c={classList:l,value:a,date:t,content:t.getDate()};if(this.process)c=this.process(c);return'<a href="#" class="'+i.trim(c.classList.join(" "))+'"data-week="'+c.date.getDay()+'" data-date="'+c.value+'">'+c.content+"</a>"},page:function(t){var e=new Date(this.month),i="next"===t?1:-1;e.setMonth(e.getMonth()+i),e.setDate(1),this.set("month",e),this.fire("page",{month:e})},updatePrevNextStatus:function(t){var e=this.range;if(e){var n=this.getYYYYMM(t);i(this.prev)[e.begin&&n<=this.getYYYYMM(e.begin)?"hide":"show"](),i(this.next)[e.end&&n>=this.getYYYYMM(e.end)?"hide":"show"]()}},pick:function(t){t=i(t);var e=t.data("date");if(this.value===e)return void this.hide();var n=this.parse(e,h);e=this.format(n);var a=this.fire("change",{value:e});if(!a.isDefaultPrevented())this.hide(),i(this.input).focus(),this.set("value",e)},onPopupClick:function(t){var e=this.helper,n=i(t.target).closest("a",this.popup.main);if(n.is("a")){if(t.preventDefault(),n.hasClass(e.getPrimaryClassName("pager")))return void this.page(n.data("direction"));if(!n.hasClass(e.getPrimaryClassName("disabled")))this.pick(n)}},onPopupBeforeShow:function(e){var i=this.fire("show");if(i.isDefaultPrevented())return void e.preventDefault();var n=this.date;if(n)this.set("month",t(n))},onPopupHide:function(t){this.fire(t)},dispose:function(){this.popup.destroy(),this.popup=null}});return u.DATE_FORMAT=h,u.RANGE=o,u});