/*! 2015 Baidu Inc. All Rights Reserved */
define("moye/ui/Calendar",["require","jquery","./lib","./Control","./Popup","./painter"],function(require){function t(t){var e=new Date(t);return e.setDate(1),e}function e(t){var e=new Date(t);return e.setMonth(e.getMonth()+1),e.setDate(0),e}var i=require("jquery"),a=require("./lib"),n=require("./Control"),s=require("./Popup"),r=a.pad,h="yyyy-MM-dd",o=null,u=n.extend({type:"Calendar",options:{dateFormat:h,range:o,process:null,months:1,weekStart:0,lang:{week:"周",days:"日,一,二,三,四,五,六",title:"{year}年{month}月"},pager:{next:"&#xe606;",prev:"&#xe605;"}},init:function(e){this.$parent(e);var i=this.main;if("INPUT"===i.tagName){var a=document.createElement("div"),n=i.parentNode;if(n)n.insertBefore(a,i);a.appendChild(i),this.main=a,this.input=i}var s=this.value||this.input&&this.input.value,r=this.date=this.parse(s);this.days=this.lang.days.split(","),this.month=t(r),this.value=this.format(r)},getPagerHTML:function(t){var e=this.helper,i=e.getPartId(t),a=["moye-icon"].concat(e.getPartClasses("pager")).concat(e.getPartClasses("pager-"+t)).join(" "),n=this.pager[t];return'<a href="#" data-direction="'+t+'"class="'+a+'" id="'+i+'">'+n+"</a>"},initStructure:function(){var t=this.main,e=this.input;if(!e)e=this.input=i("input",t)[0]||i('<input type="text">').appendTo(t).get(0);var a=this.helper,n=""+this.getPagerHTML("prev")+this.getPagerHTML("next")+a.getPartHTML("content","ol"),r=this.popup=new s({target:e,triggers:[e],content:n,showDelay:0,hideDelay:0});r.render(),a.addPartClasses("popup",r.main),this.prev=a.getPart("prev"),this.next=a.getPart("next"),this.content=a.getPart("content")},initEvents:function(){this.popup.on("click",i.proxy(this.onPopupClick,this)).on("hide",i.proxy(this.onPopupHide,this)).on("show",i.proxy(this.onPopupBeforeShow,this))},repaint:require("./painter").createRepaint(n.prototype.repaint,{name:["range","value"],paint:function(e,i,a){var n=this.date=this.parse(a);if(i){var s=i.begin,r=i.end;if(s)s=i.begin=this.parse(s);if(r)r=i.end=this.parse(r);if(s>n||n>r)a=this.value=this.date="",this.month=t(s||r)}this.input.value=a}},{name:["months","month","range","value"],paint:function(e,i,a){var n=[];i=this.months=i||1,a=t(a||this.month),this.updatePrevNextStatus(a);for(var s=0;i>s;s++)n[s]=this.getMonthHTML(a),a.setMonth(a.getMonth()+1);this.content.innerHTML=n.join("")}}),parse:function(t,e){if(!t)return new Date;if(a.isDate(t))return t;e=e||this.dateFormat,e=e.split(/[^yMdW]+/i),t=t.split(/\D+/);for(var i={},n=0,s=e.length;s>n;n++)if(e[n]&&t[n]&&(e[n].length>1&&t[n].length===e[n].length||1===e[n].length))i[e[n].toLowerCase()]=t[n];var r=i.yyyy||i.y||(i.yy<50?"20":"19")+i.yy,h=0|(i.m||i.mm),o=0|(i.d||i.dd);return new Date(0|r,h-1,o)},format:function(t,e){if(e=(e||this.dateFormat).toLowerCase(),a.isString(t))t=this.parse(t);var i=this.weekStart,n=t.getFullYear(),s=t.getMonth()+1,h=t.getDate(),o=t.getDay();if(i)o=(o-1+7)%7;o=this.days[o];var u={yyyy:n,yy:n%100,y:n,mm:r(s),m:s,dd:r(h),d:h,w:o,ww:this.lang.week+o};return e.replace(/y+|M+|d+|W+/gi,function(t){return u[t]||""})},show:function(t){this.popup.show()},hide:function(){this.popup.hide()},getValue:function(){var t=this.date;return t?this.format(t):""},getRawValue:function(){return this.date},setRange:function(t){this.range=null,this.set("range",t)},setValue:function(t){this.set("value",t)},getYYYYMM:function(t){return a.isString(t)?t:this.format(this.parse(t),"yyyyMM")},getMonthHTML:function(i){var a=this.helper,n=['<li class="'+a.getPartClassName("month")+'">',this.getMontnTitleHTML(i),this.getWeekTitleHTML(),"<p>"],s=t(i),r=e(i),h=s.getDay(),o=new Date(s);o.setDate(1-h);for(var u=0;42>u;u++){if(s>o)n.push(this.getDateHTML(o,"prev-month"));else if(o>r)n.push(this.getDateHTML(o,"next-month"));else n.push(this.getDateHTML(o));o.setDate(o.getDate()+1)}return n.push("</p></li>"),n.join("")},getMontnTitleHTML:function(t){t={year:t.getFullYear(),month:t.getMonth()+1};var e=this.lang.title.replace(/\{([^\}]+)\}/g,function(e,i){return t[i]||""});return"<h3>"+e+"</h3>"},getWeekTitleHTML:function(){for(var t=["<ul>"],e=this.helper,i=this.days,a=this.weekStart,n=e.getPartClassName("week"),s=this.helper.getPartClassName("weekend"),r=0;7>r;r++){var h=(a+r)%7,o=[n,0===r||6===r?s:""];t.push('<li class="'+o.join(" ")+'">'+i[h]+"</li>")}return t.push("</ul>"),t.join("")},getDateHTML:function(t,e){var a=t.getDay(),n=this.format(t),s=this.helper,r=this.range,h=!!r&&(r.begin>t||r.end<t),o=this.value&&this.value===n,u=this.format(new Date),l=s.getPartClasses("date");if(0===a||6===a)l.push(s.getPartClassName("weekend"));if(e)l.push(s.getPartClassName(e));if(h)l.push(s.getPartClassName("disabled"));if(o)l.push(s.getPartClassName("checked"));if(n===u)l.push(s.getPartClassName("today"));var p={classList:l,value:n,date:t,content:t.getDate()};if(this.process)p=this.process(p);return'<a href="#" class="'+i.trim(p.classList.join(" "))+'"data-week="'+p.date.getDay()+'" data-date="'+p.value+'">'+p.content+"</a>"},page:function(t){var e=new Date(this.month),i="next"===t?1:-1;e.setMonth(e.getMonth()+i),e.setDate(1),this.set("month",e)},updatePrevNextStatus:function(t){var e=this.range;if(e){var a=this.getYYYYMM(t);i(this.prev)[e.begin&&a<=this.getYYYYMM(e.begin)?"hide":"show"](),i(this.next)[e.end&&a>=this.getYYYYMM(e.end)?"hide":"show"]()}},pick:function(t){t=i(t);var e=t.data("date");if(this.value===e)return void this.hide();var a=this.parse(e,h);e=this.format(a);var n=this.fire("change",{value:e});if(!n.isDefaultPrevented())this.hide(),i(this.input).focus(),this.set("value",e)},onPopupClick:function(t){var e=this.helper,a=i(t.target).closest("a",this.popup.main);if(a.is("a")){if(t.preventDefault(),a.hasClass(e.getPrimaryClassName("pager")))return void this.page(a.data("direction"));if(!a.hasClass(e.getPrimaryClassName("disabled")))this.pick(a)}},onPopupBeforeShow:function(e){var i=this.fire("show");if(i.isDefaultPrevented())return void e.preventDefault();var a=this.date;if(a)this.set("month",t(a))},onPopupHide:function(t){this.fire(t)},dispose:function(){this.popup.destroy(),this.popup=null}});return u.DATE_FORMAT=h,u.RANGE=o,u});