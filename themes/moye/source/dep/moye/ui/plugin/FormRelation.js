/*! 2015 Baidu Inc. All Rights Reserved */
define("moye/ui/plugin/FormRelation",["require","jquery","../lib","./Plugin"],function(require){var t=require("jquery"),e=require("../lib"),i=require("./Plugin"),n={show:function(t){t?this.show():this.hide()},hide:function(t){t?this.hide():this.show()},disable:function(t){t?this.disable():this.enable()},enable:function(t){t?this.enable():this.disable()}},s={equal:function(t){return this.getValue()===t.value},valid:function(t){return this.checkValidity()}},r={all:function(t){for(var e=t.length-1;e>=0;e--)if(!t[e])return!1;return!0},any:function(t){for(var e=t.length-1;e>=0;e--)if(t[e])return!0;return!1}},a=i.extend({$class:"FormRelation",options:{relations:[]},initialize:function(e){this.$parent(e),this.onFieldChange=t.proxy(this.onFieldChange,this)},activate:function(e){var i=this;if(!i.isActivated())i.control=e,e.once("afterrender",t.proxy(i.bindEvents,i)),i.$parent()},inactivate:function(){if(this.isActivated())this.control.un("fieldchange",this.onFieldChange),this.$parent()},bindEvents:function(){var t=this,i=t.control;e.each(i.getInputControls(),function(e){t.check(e)}),i.on("fieldchange",t.onFieldChange)},onFieldChange:function(t){this.check(t.target)},check:function(i){var n=this.relations;if(n&&n.length){var s=this.findRelies(i);if(s.length)e.each(s,function(i){var n=this.getRelationState(i),s=[].concat(i.targets),r=[].concat(i.actions);if(e.isPromise(n))n.then(t.proxy(this.execute,this,s,r));else this.execute(s,r,n)},this)}},findRelies:function(t){for(var e=this.relations,i=[],n=e.length-1;n>=0;n--)for(var s=e[n],r=0,a=s.dependences.length;a>r;r++){var o=s.dependences[r];if(o.id===t.id){i.push(s);break}}return i},getRelationState:function(i){for(var n=this,s=[],r=!1,a=0,o=i.dependences,h=o.length;h>a;a++){var l=o[a],u=s[a]=n.getLogicState(l);if(!r&&e.isPromise(u))r=!0}return r?t.when.apply(null,s).then(function(){return n.getPatternState(i,[].slice.call(arguments))}):n.getPatternState(i,s)},getLogicState:function(t){var i=t.id,n=this.getField(i);if(!n)throw new Error("lost field control["+i+"]");var r=t.logic;return r=e.isFunction(r)?r:s[r],r?r.call(n,t):!1},getField:function(t){for(var e=this.control.getInputControls(),i=e.length-1;i>=0;i--){var n=e[i],s=n.id;if(s===t)return n}return null},getPatternState:function(t,i){var n=t.pattern||r.all;return n=e.isFunction(n)?n:r[n],n?n(i):!1},execute:function(t,i,s){var r=this.control;e.each(t,function(t){if(t=r.context.get(t))e.each(i,function(i){i=e.isFunction(i)?i:n[i],i&&i.call(t,s)})})},dispose:function(){this.control=null,this.$parent()}});return a.patterns=r,a.logics=s,a.actions=n,a});