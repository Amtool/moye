/*! 2015 Baidu Inc. All Rights Reserved */
define("moye/plugin/FormRelation",["require","jquery","../lib","./Plugin"],function(require){var t=require("jquery"),e=require("../lib"),i=require("./Plugin"),n={show:function(t){t?this.show():this.hide()},hide:function(t){t?this.hide():this.show()},disable:function(t){t?this.disable():this.enable()},enable:function(t){t?this.enable():this.disable()}},r={equal:function(t){return this.getValue()===t.value},valid:function(t){return this.checkValidity()}},s={all:function(t){for(var e=t.length-1;e>=0;e--)if(!t[e])return!1;return!0},any:function(t){for(var e=t.length-1;e>=0;e--)if(t[e])return!0;return!1}},a=i.extend({$class:"FormRelation",options:{relations:[]},initialize:function(e){this.$parent(e),this.onFieldChange=t.proxy(this.onFieldChange,this)},activate:function(e){var i=this;if(!i.isActivated())i.control=e,e.once("afterrender",t.proxy(i.bindEvents,i)),i.$parent()},inactivate:function(){if(this.isActivated())this.control.un("fieldchange",this.onFieldChange),this.$parent()},bindEvents:function(){var t=this,i=t.control;e.each(i.getInputControls(),function(e){t.check(e)}),i.on("fieldchange",t.onFieldChange)},onFieldChange:function(t){this.check(t.target)},check:function(i){var n=this.relations;if(n&&n.length){var r=this.findRelies(i);if(r.length)e.each(r,function(i){var n=this.getRelationState(i),r=[].concat(i.targets),s=[].concat(i.actions);if(e.isPromise(n))n.then(t.proxy(this.execute,this,r,s));else this.execute(r,s,n)},this)}},findRelies:function(t){for(var e=this.relations,i=[],n=e.length-1;n>=0;n--)for(var r=e[n],s=0,a=r.dependences.length;a>s;s++){var o=r.dependences[s];if(o.id===t.id){i.push(r);break}}return i},getRelationState:function(i){for(var n=this,r=[],s=!1,a=0,o=i.dependences,h=o.length;h>a;a++){var l=o[a],u=r[a]=n.getLogicState(l);if(!s&&e.isPromise(u))s=!0}return s?t.when.apply(null,r).then(function(){return n.getPatternState(i,[].slice.call(arguments))}):n.getPatternState(i,r)},getLogicState:function(t){var i=t.id,n=this.getField(i);if(!n)throw new Error("lost field control["+i+"]");var s=t.logic;return s=e.isFunction(s)?s:r[s],s?s.call(n,t):!1},getField:function(t){for(var e=this.control.getInputControls(),i=e.length-1;i>=0;i--){var n=e[i],r=n.id;if(r===t)return n}return null},getPatternState:function(t,i){var n=t.pattern||s.all;return n=e.isFunction(n)?n:s[n],n?n(i):!1},execute:function(t,i,r){var s=this.control;e.each(t,function(t){if(t=s.context.get(t))e.each(i,function(i){i=e.isFunction(i)?i:n[i],i&&i.call(t,r)})})},dispose:function(){this.control=null,this.$parent()}});return a.patterns=s,a.logics=r,a.actions=n,a});