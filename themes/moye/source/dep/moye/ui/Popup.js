/*! 2015 Baidu Inc. All Rights Reserved */
define("moye/Popup",["require","jquery","./lib","./Control","./painter"],function(require){var t=require("jquery"),e=require("./lib"),i=require("./Control"),s=i.extend({type:"Popup",options:{target:"",triggers:"",liveTriggers:"",content:"",dir:"bl",mode:"click",showDelay:50,hideDelay:50,offset:{x:0,y:0}},init:function(t){if(this.$parent(t),t.target)this.target=e.g(t.target);if("over"===t.mode)this.showDelay=t.showDelay>0?t.showDelay:50,this.hideDelay=t.hideDelay>0?t.hideDelay:50},initStructure:function(){var e=this.content=this.content||this.main.innerHTML;t(this.main).css("left","-2000px").appendTo(document.body).html(e)},initEvents:function(){if(this.onWindowResize=e.debounce.call(this,this.onWindowResize,100),this.showBound=t.proxy(this.onShow,this),this.hideBound=t.proxy(this.onHide,this),this.bindTriggersEvents(this.triggers,this.liveTriggers),this.delegate(this.main,"click",this.onMainClick),"over"===this.mode)this.delegate(this.main,"mouseenter",this.onMainMouseEnter),this.delegate(this.main,"mouseleave",this.onMainMouseLeave)},repaint:require("./painter").createRepaint(i.prototype.repaint,{name:"content",paint:function(t,e){this.setContent(e)}},function(t,e){if(!this.helper.isInStage("RENDERED"))return this;var i=e.liveTriggers,s=e.triggers;if(!i&&!s)return this;else return this.clearTriggersEvents(s.oldValue,i.oldValue),void this.bindTriggersEvents(s.newValue,i.newValue)}),setTarget:function(t){return this.target=t,this},bindTriggersEvents:function(e,i){var s,n=this.mode,r=this.showBound,a=this.hideBound,h=null;if("static"!==n){if(i)s=t(i),h=e;else s=t(e);if("over"===n)s.on("mouseenter",h,r).on("mouseleave",h,a),t(this.main).on("mouseenter",r).on("mouseleave",a);else s.on("click",h,r)}},clearTriggersEvents:function(e,i){var s,n=this.mode,r=null;if("static"!==n){if(i)s=t(i),r=e;else s=t(e);if("over"===n)s.off("mouseenter",r,this.showBound).off("mouseleave",r,this.hideBound),this.undelegate(this.main,"mouseenter",this.onMainMouseEnter),this.undelegate(this.main,"mouseleave",this.onMainMouseLeave);else t(e).off("click",this.showBound)}},startGlobalListener:function(){var t=this.mode;if("click"===t)this.delegate(document,"click",this.onHide);return this.delegate(window,"resize",this.onWindowResize),this},stopGlobalListener:function(){var t=this.mode;if("click"===t)this.undelegate(document,"click",this.onHide);return this.undelegate(window,"resize",this.onWindowResize),this},show:function(){var t=this;if(!t.hasState("show")){t.addState("show");var e=function(){t.locate(t.target||t.trigger),t.startGlobalListener(),t._isVisible=!0,t.fire("show",{target:t.trigger})};if(t.showDelay)t._showTimer=setTimeout(e,t.showDelay);else e();return clearTimeout(t._hideTimer),this}},hide:function(){var e=this;if(e.hasState("show")){e.removeState("show");var i=function(){t(e.main).css("left","-2000px"),e.stopGlobalListener(),e.trigger=null,e._isVisible=!1,e.fire("hide")};if(e.hideDelay)e._hideTimer=setTimeout(i,e.hideDelay);else i();return clearTimeout(e._showTimer),this}},onWindowResize:function(){var t=this.target||this.trigger;t&&this.isVisible()&&this.locate(t)},onShow:function(e){if(!this.isDisabled()){var i=e.target,s=this.main,n=i===s||t.contains(s,i),r=n?this.trigger:t(e.target).closest(this.triggers)[0];if(r){var a=this.trigger;if(a)if(this.hide(),!n&&r===a)return;var h=new t.Event("beforeshow",{target:r});if(this.fire(h),!h.isDefaultPrevented())this.trigger=r,this.show()}}},onHide:function(e){var i=e.target,s=this.main;if("mouseleave"===e.type||s!==i&&!~t.inArray(i,t(this.triggers))&&!t.contains(s,i))this.hide()},onMainClick:function(t){this.fire(t)},onMainMouseEnter:function(t){this.clear()},onMainMouseLeave:function(t){this.clear(),this.addState("show"),this.hide()},locate:function(e){e=t(e||this.target||this.trigger||document.body);var i=t(this.main),s=this.dir,n=e.offset(),r=n.top,a=n.left,h=e.outerWidth(),o=e.outerHeight(),l=a+h,u=r+o,c=a+h/2,d=r+o/2,f=i.outerWidth(),p=i.outerHeight(),g=t(window),m=g.scrollTop(),v=g.scrollLeft(),y=v+g.width(),b=m+g.height(),w=e.attr("data-popup")||e.attr("data-tooltips");if(w)s=/[trblc]{2}/.test(w)?w:"1";var x,C;if(!s||"1"===s){var k=h>f||a-(f-h)/2>0&&y>=l+(f-h)/2?"c":a+f>y?"r":"l",S=o>p||r-(p-o)/2>0&&b>=u+(p-o)/2?"c":r+p>b?"b":"t";if(b>=u+p)C="b",x=k;else if(y>=l+f)C="r",x=S;else if(r-p>=m)C="t",x=k;else if(a-f>=v)C="l",x=S;s=C+x}else C=s.charAt(0),x=s.charAt(1);this._dir=s;var T=this.offset;if({t:1,b:1}[C])a={l:a+T.x,c:c-f/2,r:l-f-T.x}[x],r={t:r-p-T.y,b:u+T.y}[C];else if({l:1,r:1}[C])r={t:r+T.y,c:d-p/2,b:u-p-T.y}[x],a={l:a-f-T.x,r:l+T.x}[C];i.css({left:a+"px",top:r+"px"})},setContent:function(e){this.content=e||"",t(this.main).html(this.content)},isVisible:function(){return!!this._isVisible},clear:function(){clearTimeout(this._showTimer),clearTimeout(this._hideTimer)},dispose:function(){this.stopGlobalListener(),this.clearTriggersEvents(this.triggers,this.liveTriggers),this.clear(),this.$parent()}});return s});