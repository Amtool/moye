/*! 2015 Baidu Inc. All Rights Reserved */
define("moye/ui/Popup",["require","jquery","./lib","./Control","./painter"],function(require){var t=require("jquery"),e=require("./lib"),i=require("./Control"),n=i.extend({type:"Popup",options:{target:"",triggers:"",liveTriggers:"",content:"",dir:"bl",mode:"click",showDelay:50,hideDelay:50,offset:{x:0,y:0}},init:function(t){if(this.$parent(t),t.target)this.target=e.g(t.target);if("over"===t.mode)this.showDelay=t.showDelay>0?t.showDelay:50,this.hideDelay=t.hideDelay>0?t.hideDelay:50},initStructure:function(){var e=this.content=this.content||this.main.innerHTML;t(this.main).css("left","-2000px").appendTo(document.body).html(e)},initEvents:function(){if(this.onWindowResize=e.debounce.call(this,this.onWindowResize,100),this.showBound=t.proxy(this.onShow,this),this.hideBound=t.proxy(this.onHide,this),this.bindTriggersEvents(this.triggers,this.liveTriggers),this.delegate(this.main,"click",this.onMainClick),"over"===this.mode)this.delegate(this.main,"mouseenter",this.onMainMouseEnter),this.delegate(this.main,"mouseleave",this.onMainMouseLeave)},repaint:require("./painter").createRepaint(i.prototype.repaint,{name:"content",paint:function(t,e){this.setContent(e)}},function(t,e){if(!this.helper.isInStage("RENDERED"))return this;var i=e.liveTriggers,n=e.triggers;if(!i&&!n)return this;else return this.clearTriggersEvents(n.oldValue,i.oldValue),void this.bindTriggersEvents(n.newValue,i.newValue)}),setTarget:function(t){return this.target=t,this},bindTriggersEvents:function(e,i){var n,s=this.mode,r=this.showBound,a=this.hideBound,o=null;if("static"!==s){if(i)n=t(i),o=e;else n=t(e);if("over"===s)n.on("mouseenter",o,r).on("mouseleave",o,a),t(this.main).on("mouseenter",r).on("mouseleave",a);else n.on("click",o,r)}},clearTriggersEvents:function(e,i){var n,s=this.mode,r=null;if("static"!==s){if(i)n=t(i),r=e;else n=t(e);if("over"===s)n.off("mouseenter",r,this.showBound).off("mouseleave",r,this.hideBound),this.undelegate(this.main,"mouseenter",this.onMainMouseEnter),this.undelegate(this.main,"mouseleave",this.onMainMouseLeave);else t(e).off("click",this.showBound)}},startGlobalListener:function(){var t=this.mode;if("click"===t)this.delegate(document,"click",this.onHide);return this.delegate(window,"resize",this.onWindowResize),this},stopGlobalListener:function(){var t=this.mode;if("click"===t)this.undelegate(document,"click",this.onHide);return this.undelegate(window,"resize",this.onWindowResize),this},show:function(){var t=this;if(!t.hasState("show")){t.addState("show");var e=function(){t.locate(t.target||t.trigger),t.startGlobalListener(),t._isVisible=!0,t.fire("show",{target:t.trigger})};if(t.showDelay)t._showTimer=setTimeout(e,t.showDelay);else e();return clearTimeout(t._hideTimer),this}},hide:function(){var e=this;if(e.hasState("show")){e.removeState("show");var i=function(){t(e.main).css("left","-2000px"),e.stopGlobalListener(),e.trigger=null,e._isVisible=!1,e.fire("hide")};if(e.hideDelay)e._hideTimer=setTimeout(i,e.hideDelay);else i();return clearTimeout(e._showTimer),this}},onWindowResize:function(){var t=this.target||this.trigger;t&&this.isVisible()&&this.locate(t)},onShow:function(e){if(!this.isDisabled()){var i=e.target,n=this.main,s=i===n||t.contains(n,i),r=s?this.trigger:t(e.target).closest(this.triggers)[0];if(r){var a=this.trigger;if(a)if(this.hide(),!s&&r===a)return;var o=new t.Event("beforeshow",{target:r});if(this.fire(o),!o.isDefaultPrevented())this.trigger=r,this.show()}}},onHide:function(e){var i=e.target,n=this.main;if("mouseleave"===e.type||n!==i&&!~t.inArray(i,t(this.triggers))&&!t.contains(n,i))this.hide()},onMainClick:function(t){this.fire(t)},onMainMouseEnter:function(t){this.clear()},onMainMouseLeave:function(t){this.clear(),this.addState("show"),this.hide()},locate:function(e){e=t(e||this.target||this.trigger||document.body);var i=t(this.main),n=this.dir,s=e.offset(),r=s.top,a=s.left,o=e.outerWidth(),h=e.outerHeight(),l=a+o,u=r+h,c=a+o/2,f=r+h/2,d=i.outerWidth(),p=i.outerHeight(),m=t(window),g=m.scrollTop(),v=m.scrollLeft(),y=v+m.width(),b=g+m.height(),w=e.attr("data-popup")||e.attr("data-tooltips");if(w)n=/[trblc]{2}/.test(w)?w:"1";var C,x;if(!n||"1"===n){var T=o>d||a-(d-o)/2>0&&y>=l+(d-o)/2?"c":a+d>y?"r":"l",k=h>p||r-(p-h)/2>0&&b>=u+(p-h)/2?"c":r+p>b?"b":"t";if(b>=u+p)x="b",C=T;else if(y>=l+d)x="r",C=k;else if(r-p>=g)x="t",C=T;else if(a-d>=v)x="l",C=k;n=x+C}else x=n.charAt(0),C=n.charAt(1);this._dir=n;var S=this.offset;if({t:1,b:1}[x])a={l:a+S.x,c:c-d/2,r:l-d-S.x}[C],r={t:r-p-S.y,b:u+S.y}[x];else if({l:1,r:1}[x])r={t:r+S.y,c:f-p/2,b:u-p-S.y}[C],a={l:a-d-S.x,r:l+S.x}[x];i.css({left:a+"px",top:r+"px"})},setContent:function(e){this.content=e||"",t(this.main).html(this.content)},isVisible:function(){return!!this._isVisible},clear:function(){clearTimeout(this._showTimer),clearTimeout(this._hideTimer)},dispose:function(){this.stopGlobalListener(),this.clearTriggersEvents(this.triggers,this.liveTriggers),this.clear(),this.$parent()}});return n});